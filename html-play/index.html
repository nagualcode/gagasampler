<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gaga Sampler 3</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #222;
            color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #startScreen, #resultScreen {
            position: absolute;
            z-index: 2;
            text-align: center;
        }
        #startBtn {
            padding: 20px 40px;
            font-size: 24px;
            border: none;
            border-radius: 10px;
            background: #4caf50;
            color: white;
            cursor: pointer;
        }
        #grid {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 90vmin;
            height: 90vmin;
            gap: 5px;
        }
        .grid-item {
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            aspect-ratio: 1 / 1;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .rotate {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            from {transform: rotate(0deg);}
            to {transform: rotate(360deg);}
        }
    </style>
</head>
<body>

<div id="startScreen">
    <button id="startBtn">START</button>
</div>

<div id="resultScreen" style="display:none;">
    <h1 id="resultText"></h1>
</div>

<div id="grid"></div>

<script>
    const grid = document.getElementById("grid");
    const startScreen = document.getElementById("startScreen");
    const resultScreen = document.getElementById("resultScreen");
    const resultText = document.getElementById("resultText");

    let clickCount = 0;
    let totalGames = 0;
    let currentImageDiv = null;
    let currentAudio = null;
    let userSequence = [];
    let sequenceHistory = JSON.parse(localStorage.getItem("sequenceHistory") || "[]");
    let nextWinningAttempt = getRandomWinAttempt();
    let playingAudios = [];

    function getRandomWinAttempt() {
        const options = [3, 4, 5, 6];
        const chosen = options[Math.floor(Math.random() * options.length)];
        console.log(`ðŸŽ² Nova tentativa sorteada para vitÃ³ria: tentativa nÃºmero ${chosen}`);
        return chosen;
    }

    const stopAudioAndRotation = (imageDiv) => {
        if (imageDiv) {
            console.log("ðŸ›‘ Removendo rotaÃ§Ã£o da imagem.");
            imageDiv.classList.remove("rotate");
        }
    };

    const playAudio = (src, imageDiv = null) => {
        return new Promise((resolve) => {
            console.log(`â–¶ï¸ Tocando Ã¡udio: ${src}`);
            const audio = new Audio(src);
            playingAudios.push(audio);
            audio.play();
            audio.onended = () => {
                console.log(`âœ… Ãudio finalizado: ${src}`);
                if (imageDiv) stopAudioAndRotation(imageDiv);
                playingAudios = playingAudios.filter(a => a !== audio);
                resolve();
            };
        });
    };

    const playFeedbackSequence = async () => {
        console.log("ðŸ”Š Tocando sequÃªncia de feedback com sobreposiÃ§Ã£o...");
        const delays = 500;
        const promises = [];

        userSequence.forEach((num, index) => {
            const audioFile = `audio/f${num.toString().padStart(2, "0")}.mp3`;

            const promise = new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`â–¶ï¸ Tocando: ${audioFile}`);
                    const audio = new Audio(audioFile);
                    audio.play();
                    audio.onended = () => {
                        console.log(`âœ… Finalizado: ${audioFile}`);
                        resolve();
                    };
                }, index * delays);
            });

            promises.push(promise);
        });

        await Promise.all(promises);
    };

    const resetGame = () => {
        console.log("ðŸ”„ Reiniciando jogo...");
        startScreen.style.display = "flex";
        resultScreen.style.display = "none";
        grid.style.display = "none";
        grid.innerHTML = "";
        clickCount = 0;
        currentImageDiv = null;
        userSequence = [];
        playingAudios = [];
    };

    const handleResult = async () => {
        console.log("ðŸŽ¯ 6 cliques realizados. Aguardando final do Ãºltimo Ã¡udio...");

        if (playingAudios.length > 0) {
            await new Promise(resolve => {
                const lastAudio = playingAudios[playingAudios.length - 1];
                lastAudio.onended = resolve;
            });
        }

        resultScreen.style.display = "flex";
        grid.style.display = "none";
        resultText.innerText = "Conferindo a SequÃªncia Digitada...";
        await playFeedbackSequence();

        totalGames++;
        const sequenceString = userSequence.join(",");
        console.log(`ðŸ“Š Tentativa atual: ${totalGames}`);
        console.log(`ðŸ§© SequÃªncia digitada: ${sequenceString}`);

        let isWinner = false;

        while (true) {
            const alreadyExists = sequenceHistory.includes(sequenceString);

            if (totalGames === nextWinningAttempt) {
                if (alreadyExists) {
                    console.log("âš ï¸ SequÃªncia repetida! Anulando tentativa premiada.");
                    totalGames++;
                    nextWinningAttempt = totalGames + getRandomWinAttempt();
                    console.log(`ðŸŽ² Nova tentativa sorteada para vitÃ³ria: ${nextWinningAttempt}`);
                    continue;
                } else {
                    console.log("ðŸŽ‰ VitÃ³ria vÃ¡lida! SequÃªncia inÃ©dita.");
                    isWinner = true;
                    sequenceHistory.push(sequenceString);
                    localStorage.setItem("sequenceHistory", JSON.stringify(sequenceHistory));
                    nextWinningAttempt = totalGames + getRandomWinAttempt();
                    console.log(`ðŸ”® PrÃ³xima tentativa sorteada para vitÃ³ria: ${nextWinningAttempt}`);
                    break;
                }
            } else {
                if (!alreadyExists) {
                    console.log("ðŸ™ Tentativa nÃ£o premiada, mas sequÃªncia Ã© nova.");
                    sequenceHistory.push(sequenceString);
                    localStorage.setItem("sequenceHistory", JSON.stringify(sequenceHistory));
                } else {
                    console.log("ðŸ™ Tentativa nÃ£o premiada e sequÃªncia jÃ¡ usada.");
                }
                break;
            }
        }

        const msg = isWinner ? "VOCÃŠ VENCEU!" : "OBRIGADO POR PARTICIPAR!";
        const resultAudio = isWinner ? "audio/win.mp3" : "audio/obrigado.mp3";

        resultText.innerText = msg;
        await playAudio(resultAudio);
        resetGame();
    };

    const showGrid = () => {
        console.log("ðŸŸ© Exibindo grid...");
        startScreen.style.display = "none";
        grid.style.display = "grid";

        for (let i = 1; i <= 9; i++) {
            const div = document.createElement("div");
            const imgFile = i.toString().padStart(2, '0');
            div.classList.add("grid-item");
            div.style.backgroundImage = `url('img/${imgFile}.jpg')`;

            div.addEventListener("click", async () => {
                if (clickCount >= 6) return;

                const imageAudio = `audio/${imgFile}.mp3`;

                console.log(`ðŸ–¼ï¸ Imagem ${i} clicada. Clique nÃºmero: ${clickCount + 1}`);
                div.classList.add("rotate");

                playAudio(imageAudio, div); // nÃ£o precisa await
                userSequence.push(i);
                clickCount++;

                if (clickCount === 6) {
                    await handleResult();
                }
            });

            grid.appendChild(div);
        }
    };

    document.getElementById("startBtn").addEventListener("click", async () => {
        console.log("ðŸŽ¬ BotÃ£o START clicado.");
        await playAudio("audio/start.mp3");
        showGrid();
    });
</script>






</body>
</html>
